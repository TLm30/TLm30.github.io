---
title: "6.824 实验一"
date: 2021-11-05T15:10:10+08:00
---

# Lab1 Map Reduce
## 要求
1. 一个协调者进程，多个工作进程
2. 通信使用RPC
3. 当一个工作进程超过１０秒还没有完成任务，协调者可以将该任务分配给其他进程

## 规则

1. map阶段应该将key分到n个buckets中
2. worker的实现应该将输出保存在文件mr-out-X中
3. 一个mr-out-X文件应该该找GO的格式分行
4. coordinator.go应该实现Done()方法
5. 当一个任务完成时，worker进程应该退出，一个简单的实现时使用call()的返回值。取决于你的实现，coordinator应该发送一个请退出的任务给其他worker

## 提示

1. worker先发送一个RPC请求coordinator一个任务，然后coordinator返回一个还没开始的任务的文件名，woker读取文件，执行map

## 过程

coordinator：

1. 读取所有的文件
2. 监听消息
3. 选择一个文件发送
4. 所有任务完成

worker：

1. 发送消息
2. 执行文件
3. 退出

## 详细设计

coordinator:

维护三个列表

1. 未完成任务列表
2. 进行中任务列表
3. 已完成任务列表

启动时，先初始化未完成任务列表，收到请求时，从未完成任务列表中挑选一个，从列表中移除，然后加入到进行中任务列表，将该任务发送给worker。收到已完成请求后，从进行中任务列表中移除，加入到已完成任务列表。

map阶段，为了使所有key相同的字符串能够写在同一个文件中，需要使用ihash函数对key进行映射。这里定义一个map，其中key是文件名，value是一个数组，数组中的元素是要写入文件的数据。然后以key为文件名，进行写入。其中key的生成规则为mr-X-Y，X是map的任务编号，由coordinator返回，Y是reduce的任务名，由ihash函数生成的数并对reducer数量取余得到，

reduce阶段，遍历所有的中间文件，处理中间文件名和自己编号相同的文件。